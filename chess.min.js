/*! chess 27-03-2014 */
!function(){!function(){"use strict";var a={},b=Array.prototype,c=Object.prototype;Function.prototype;var d=(b.push,b.slice,b.concat,c.toString,c.hasOwnProperty),e=b.forEach,f=b.filter,g={};g.each=function(b,c,d){if(null!=b)if(e&&b.forEach===e)b.forEach(c,d);else if(b.length===+b.length){for(var f=0,h=b.length;h>f;f++)if(c.call(d,b[f],f,b)===a)return}else for(var i in b)if(g.has(b,i)&&c.call(d,b[i],i,b)===a)return},g.filter=function(a,b,c){var d=[];return null==a?d:f&&a.filter===f?a.filter(b,c):(g.each(a,function(a,e,f){b.call(c,a,e,f)&&d.push(a)}),d)},g.isFunction=function(a){return"function"==typeof a},g.has=function(a,b){return d.call(a,b)};var h={};if("undefined"!=typeof exports)"undefined"!=typeof module&&module.exports&&(exports=module.exports=h),exports.jsMessage=h;else{if(void 0!==this.jsMessage)throw"jsMessage is allready defined";this.jsMessage=h}h.mixinPubSub=function(a){a=a||{};var b={},c=[];return a.subscribe=function(a,d){a?(b[a]=b[a]||[],b[a].push(d)):c.push(d)},a.unsubscribe=function(a,d){var e=function(c){return g.filter(b[c],function(b){return b!==a})};if(d){if(!b[d])throw"topic not found";b[d]=e(d)}else g.each(b,function(a,c){b[c]=e(c)}),c=g.filter(c,function(b){return b!==a})},a.publish=function(a,d){a?g.each(b[a],function(a){a(d)}):g.each(b,function(a){g.each(a,function(a){a&&a(d)})}),g.each(c,function(a){a(d)})},a.autoPublish=function(a,b){var c,d=this;return function(e){var f;return void 0===e?c:(c=e,f=b?b(e):e,d.publish(a,f),void 0)}},a},h.mixinEvents=function(a,b){var c={},d=b||{};return g.each(a,function(b,e){g.isFunction(b)&&(a[e]=function(){var f,h=b.apply(a,arguments);return c[e]&&(d[e]&&(f=d[e].apply(a,[h])),g.each(c[e],function(a){a(f)})),h})}),a.on=function(a,b){c[a]=c[a]||[],c[a].push(b)},a.off=function(a,b){c[a]=b?g.filter(c[a],function(a){return a!==b}):void 0},a}}.call(this),function(){"use strict";var a="abcdefgh".split(""),b=function(a){if("string"!=typeof a)return!1;var b=a.split("-");return 2!==b.length?!1:c(b[0])===!0&&c(b[1])===!0},c=function(a){return"string"!=typeof a?!1:-1!==a.search(/^[a-h][1-8]$/)},d=function(a){return"string"!=typeof a?!1:-1!==a.search(/^[bw][KQRNBP]$/)},e=function(a){if("string"!=typeof a)return!1;var b=a.split("/");if(b.length<8)return!1;for(var c=0;8>c;c++)if(""===b[c]||b[c].length>8||-1!==b[c].search(/[^kqrbnpKQRNBP1-8]/))return!1;return!0},f=function(a){if("object"!=typeof a)return!1;for(var b in a)if(a.hasOwnProperty(b)===!0&&(c(b)!==!0||d(a[b])!==!0))return!1;return!0},g=function(a){return a.toLowerCase()===a?"b"+a.toUpperCase():"w"+a.toUpperCase()},h=function(a){var b=a.split("");return"w"===b[0]?b[1].toUpperCase():b[1].toLowerCase()},i=function(b){if(e(b)!==!0)return!1;for(var c=b.split("/"),d={},f=8,h=0;8>h;h++){for(var i=c[h].split(""),j=0,k=0;k<i.length;k++)if(-1!==i[k].search(/[1-8]/)){var l=parseInt(i[k],10);j+=l}else{var m=a[j]+f;d[m]=g(i[k]),j++}f--}return d},j=function(b){if(f(b)!==!0)return!1;for(var c="",d=8,e=0;8>e;e++){for(var g=0;8>g;g++){var i=a[g]+d;c+=b.hasOwnProperty(i)===!0?h(b[i]):"1"}7!==e&&(c+="/"),d--}return c=c.replace(/11111111/g,"8"),c=c.replace(/1111111/g,"7"),c=c.replace(/111111/g,"6"),c=c.replace(/11111/g,"5"),c=c.replace(/1111/g,"4"),c=c.replace(/111/g,"3"),c=c.replace(/11/g,"2")};window.ChessBoard=window.ChessBoard||function(d,g){g=g||{};var h,k,l,m,n,o,p,q,r,s,t="1.7.0",u="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",v=i(u),w={alpha:"alpha-d2270",black:"black-3c85d",board:"board-b72b1",chessboard:"chessboard-63f37",clearfix:"clearfix-7da63",highlight1:"highlight1-32417",highlight2:"highlight2-9c5d2",notation:"notation-322f9",numeric:"numeric-fc462",piece:"piece-417db",row:"row-5277c",sparePieces:"spare-pieces-7492f",sparePiecesBottom:"spare-pieces-bottom-ae20f",sparePiecesTop:"spare-pieces-top-4028b",square:"square-55d63",white:"white-1e1d7"},x={},y=!1,z=2,A="white",B={},C=!1,D={},E={},F=function(){return"xxxx-xxxx-xxxx-xxxx-xxxx-xxxx-xxxx-xxxx".replace(/x/g,function(){var a=0|16*Math.random();return a.toString(16)})},G=function(a){return JSON.parse(JSON.stringify(a))},H=function(a){var b=a.split(".");return{major:parseInt(b[0],10),minor:parseInt(b[1],10),patch:parseInt(b[2],10)}},I=function(a,b){a=H(a),b=H(b);var c=1e4*1e4*a.major+1e4*a.minor+a.patch,d=1e4*1e4*b.major+1e4*b.minor+b.patch;return c>=d},J=function(a,b,c){if(g.hasOwnProperty("showErrors")===!0&&g.showErrors!==!1){var d="ChessBoard Error "+a+": "+b;return"console"===g.showErrors&&"object"==typeof console&&"function"==typeof console.log?(console.log(d),arguments.length>=2&&console.log(c),void 0):"alert"===g.showErrors?(c&&(d+="\n\n"+JSON.stringify(c)),window.alert(d),void 0):("function"==typeof g.showErrors&&g.showErrors(a,b,c),void 0)}},K=function(){if("string"==typeof d){if(""===d)return window.alert("ChessBoard Error 1001: The first argument to ChessBoard() cannot be an empty string.\n\nExiting..."),!1;var a=document.getElementById(d);if(!a)return window.alert('ChessBoard Error 1002: Element with id "'+d+'" does not exist in the DOM.'+"\n\nExiting..."),!1;h=$(a)}else if(h=$(d),1!==h.length)return window.alert("ChessBoard Error 1003: The first argument to ChessBoard() must be an ID or a single DOM node.\n\nExiting..."),!1;return window.JSON&&"function"==typeof JSON.stringify&&"function"==typeof JSON.parse?$.fn&&$.fn.jquery&&I($.fn.jquery,t)===!0?!0:(window.alert("ChessBoard Error 1005: Unable to find a valid version of jQuery. Please include jQuery "+t+" or "+"higher on the page.\n\nExiting..."),!1):(window.alert("ChessBoard Error 1004: JSON does not exist. Please include a JSON polyfill.\n\nExiting..."),!1)},L=function(a){return"fast"===a||"slow"===a?!0:parseInt(a,10)+""!=a+""?!1:a>0},M=function(){return("string"==typeof g||f(g)===!0)&&(g={position:g}),"black"!==g.orientation&&(g.orientation="white"),A=g.orientation,g.showNotation!==!1&&(g.showNotation=!0),g.draggable!==!0&&(g.draggable=!1),"trash"!==g.dropOffBoard&&(g.dropOffBoard="snapback"),g.sparePieces!==!0&&(g.sparePieces=!1),g.sparePieces===!0&&(g.draggable=!0),(g.hasOwnProperty("pieceTheme")!==!0||"string"!=typeof g.pieceTheme&&"function"!=typeof g.pieceTheme)&&(g.pieceTheme="img/chesspieces/wikipedia/{piece}.png"),(g.hasOwnProperty("moveSpeed")!==!0||L(g.moveSpeed)!==!0)&&(g.moveSpeed=200),(g.hasOwnProperty("snapbackSpeed")!==!0||L(g.snapbackSpeed)!==!0)&&(g.snapbackSpeed=50),(g.hasOwnProperty("snapSpeed")!==!0||L(g.snapSpeed)!==!0)&&(g.snapSpeed=25),(g.hasOwnProperty("trashSpeed")!==!0||L(g.trashSpeed)!==!0)&&(g.trashSpeed=100),g.hasOwnProperty("position")===!0&&("start"===g.position?B=G(v):e(g.position)===!0?B=i(g.position):f(g.position)===!0?B=G(g.position):J(7263,"Invalid value passed to config.position.",g.position)),!0},N=function(){var a=parseInt(h.css("width"),10);if(!a||0>=a)return 0;for(var b=a-1;0!==b%8&&b>0;)b--;return b/8},O=function(){for(var b=0;b<a.length;b++)for(var c=1;8>=c;c++){var d=a[b]+c;E[d]=d+"-"+F()}for(var e="KQRBNP".split(""),b=0;b<e.length;b++){var f="w"+e[b],g="b"+e[b];D[f]=f+"-"+F(),D[g]=g+"-"+F()}},P=function(){var a='<div class="'+w.chessboard+'">';return g.sparePieces===!0&&(a+='<div class="'+w.sparePieces+" "+w.sparePiecesTop+'"></div>'),a+='<div class="'+w.board+'"></div>',g.sparePieces===!0&&(a+='<div class="'+w.sparePieces+" "+w.sparePiecesBottom+'"></div>'),a+="</div>"},Q=function(b){"black"!==b&&(b="white");var c="",d=G(a),e=8;"black"===b&&(d.reverse(),e=1);for(var f="white",h=0;8>h;h++){c+='<div class="'+w.row+'">';for(var i=0;8>i;i++){var j=d[i]+e;c+='<div class="'+w.square+" "+w[f]+'" '+'style="width: '+o+"px; height: "+o+'px" '+'id="'+E[j]+'" '+'data-square="'+j+'">',g.showNotation===!0&&(("white"===b&&1===e||"black"===b&&8===e)&&(c+='<div class="'+w.notation+" "+w.alpha+'">'+d[i]+"</div>"),0===i&&(c+='<div class="'+w.notation+" "+w.numeric+'">'+e+"</div>")),c+="</div>",f="white"===f?"black":"white"}c+='<div class="'+w.clearfix+'"></div></div>',f="white"===f?"black":"white","white"===b?e--:e++}return c},R=function(a){return"function"==typeof g.pieceTheme?g.pieceTheme(a):"string"==typeof g.pieceTheme?g.pieceTheme.replace(/{piece}/g,a):(J(8272,"Unable to build image source for cfg.pieceTheme."),void 0)},S=function(a,b,c){var d='<img src="'+R(a)+'" ';return c&&"string"==typeof c&&(d+='id="'+c+'" '),d+='alt="" class="'+w.piece+'" '+'data-piece="'+a+'" '+'style="width: '+o+"px;"+"height: "+o+"px;",b===!0&&(d+="display:none;"),d+='" />'},T=function(a){var b=["wK","wQ","wR","wB","wN","wP"];"black"===a&&(b=["bK","bQ","bR","bB","bN","bP"]);for(var c="",d=0;d<b.length;d++)c+=S(b[d],!1,D[b[d]]);return c},U=function(a,b,c,d){var e=$("#"+E[a]),f=e.offset(),h=$("#"+E[b]),i=h.offset(),j=F();$("body").append(S(c,!0,j));var k=$("#"+j);k.css({display:"",position:"absolute",top:f.top,left:f.left}),e.find("img."+w.piece).remove();var l=function(){h.append(S(c)),k.remove(),"function"==typeof d&&d()},m={duration:g.moveSpeed,complete:l};k.animate(i,m)},V=function(a,b,c){var d=$("#"+D[a]).offset(),e=$("#"+E[b]),f=e.offset(),h=F();$("body").append(S(a,!0,h));var i=$("#"+h);i.css({display:"",position:"absolute",left:d.left,top:d.top});var j=function(){e.find("img."+w.piece).remove(),e.append(S(a)),i.remove(),"function"==typeof c&&c()},k={duration:g.moveSpeed,complete:j};i.animate(f,k)},W=function(a){y=!0;for(var b=0,c=function(){b++,b===a.length&&(bb(),y=!1)},d=0;d<a.length;d++)"clear"===a[d].type&&$("#"+E[a[d].square]+" img."+w.piece).fadeOut(g.trashSpeed,c),"add"===a[d].type&&g.sparePieces!==!0&&$("#"+E[a[d].square]).append(S(a[d].piece,!0)).find("img."+w.piece).fadeIn("fast",c),"add"===a[d].type&&g.sparePieces===!0&&V(a[d].piece,a[d].square,c),"move"===a[d].type&&U(a[d].source,a[d].destination,a[d].piece,c)},X=function(b,c){b=b.split("");var d=a.indexOf(b[0])+1,e=parseInt(b[1],10);c=c.split("");var f=a.indexOf(c[0])+1,g=parseInt(c[1],10),h=Math.abs(d-f),i=Math.abs(e-g);return h>=i?h:i},Y=function(b){for(var c=[],d=0;8>d;d++)for(var e=0;8>e;e++){var f=a[d]+(e+1);b!==f&&c.push({square:f,distance:X(b,f)})}c.sort(function(a,b){return a.distance-b.distance});for(var g=[],d=0;d<c.length;d++)g.push(c[d].square);return g},Z=function(a,b,c){for(var d=Y(c),e=0;e<d.length;e++){var f=d[e];if(a.hasOwnProperty(f)===!0&&a[f]===b)return f}return!1},_=function(a,b){a=G(a),b=G(b);var c=[],d={};for(var e in b)b.hasOwnProperty(e)===!0&&a.hasOwnProperty(e)===!0&&a[e]===b[e]&&(delete a[e],delete b[e]);for(var e in b)if(b.hasOwnProperty(e)===!0){var f=Z(a,b[e],e);f!==!1&&(c.push({type:"move",source:f,destination:e,piece:b[e]}),delete a[f],delete b[e],d[e]=!0)}for(var e in b)b.hasOwnProperty(e)===!0&&(c.push({type:"add",square:e,piece:b[e]}),delete b[e]);for(var e in a)a.hasOwnProperty(e)===!0&&d.hasOwnProperty(e)!==!0&&(c.push({type:"clear",square:e,piece:a[e]}),delete a[e]);return c},ab=function(){k.find("img."+w.piece).remove()},bb=function(){ab();for(var a in B)B.hasOwnProperty(a)===!0&&$("#"+E[a]).append(S(B[a]))},cb=function(){k.html(Q(A)),bb(),g.sparePieces===!0&&("white"===A?(m.html(T("black")),n.html(T("white"))):(m.html(T("white")),n.html(T("black"))))},db=function(a,b){W(_(a,b))},eb=function(a,b){a=G(a);for(var c in b)if(b.hasOwnProperty(c)===!0&&a.hasOwnProperty(c)===!0){var d=a[c];delete a[c],a[b[c]]=d}return a},fb=function(a){var b=G(B),c=G(a),d=j(b),e=j(c);d!==e&&(g.hasOwnProperty("onChange")===!0&&"function"==typeof g.onChange&&g.onChange(b,c),B=a)},gb=function(a,b){for(var c in s)if(s.hasOwnProperty(c)===!0){var d=s[c];if(a>=d.left&&a<d.left+o&&b>=d.top&&b<d.top+o)return c}return"offboard"},hb=function(){s={};for(var a in E)E.hasOwnProperty(a)===!0&&(s[a]=$("#"+E[a]).offset())},ib=function(){k.find("div."+w.square).removeClass(w.highlight1+" "+w.highlight2)},jb=function(){if("spare"===r)return kb(),void 0;ib();var a=function(){bb(),l.css("display","none")},b=$("#"+E[r]).offset(),c={duration:g.snapbackSpeed,complete:a};l.animate(b,c),C=!1},kb=function(){ib();var a=G(B);delete a[r],fb(a),bb(),l.fadeOut(g.trashSpeed),C=!1},lb=function(a){ib();var b=G(B);delete b[r],b[a]=p,fb(b);var c=$("#"+E[a]).offset(),d=function(){bb(),l.css("display","none")},e={duration:g.snapSpeed,complete:d};l.animate(c,e),C=!1},mb=function(a,b,c,d){("function"!=typeof g.onDragStart||g.onDragStart(a,b,G(B),A)!==!1)&&(C=!0,p=b,r=a,q="spare"===a?"offboard":a,hb(),l.attr("src",R(b)).css({display:"",position:"absolute",left:c-o/2,top:d-o/2}),"spare"!==a&&$("#"+E[a]).addClass(w.highlight1).find("img."+w.piece).css("display","none"))},nb=function(a,b){l.css({left:a-o/2,top:b-o/2});var d=gb(a,b);d!==q&&(c(q)===!0&&$("#"+E[q]).removeClass(w.highlight2),c(d)===!0&&$("#"+E[d]).addClass(w.highlight2),"function"==typeof g.onDragMove&&g.onDragMove(d,q,r,p,G(B),A),q=d)},ob=function(a){var b="drop";if("offboard"===a&&"snapback"===g.dropOffBoard&&(b="snapback"),"offboard"===a&&"trash"===g.dropOffBoard&&(b="trash"),g.hasOwnProperty("onDrop")===!0&&"function"==typeof g.onDrop){var d=G(B);"spare"===r&&c(a)===!0&&(d[a]=p),c(r)===!0&&"offboard"===a&&delete d[r],c(r)===!0&&c(a)===!0&&(delete d[r],d[a]=p);var e=G(B),f=g.onDrop(r,a,p,d,e,A);("snapback"===f||"trash"===f)&&(b=f)}"snapback"===b?jb():"trash"===b?kb():"drop"===b&&lb(a)};x.clear=function(a){x.position({},a)},x.destroy=function(){h.html(""),l.remove(),h.unbind()},x.fen=function(){return x.position("fen")},x.flip=function(){x.orientation("flip")},x.move=function(){if(0!==arguments.length){for(var a={},c=0;c<arguments.length;c++)if(b(arguments[c])===!0){var d=arguments[c].split("-");a[d[0]]=d[1]}else J(2826,"Invalid move passed to the move method.",arguments[c]);var e=eb(B,a);return x.position(e),e}},x.orientation=function(a){return 0===arguments.length?A:"white"===a||"black"===a?(A=a,cb(),void 0):"flip"===a?(A="white"===A?"black":"white",cb(),void 0):(J(5482,"Invalid value passed to the orientation method.",a),void 0)},x.position=function(a,b){return 0===arguments.length?G(B):"string"==typeof a&&"fen"===a.toLowerCase()?j(B):(b!==!1&&(b=!0),"string"==typeof a&&"start"===a.toLowerCase()&&(a=G(v)),e(a)===!0&&(a=i(a)),f(a)!==!0?(J(6482,"Invalid value passed to the position method.",a),void 0):(b===!0?(db(B,a),fb(a)):(fb(a),bb()),void 0))},x.resize=function(){o=N(),k.css("width",8*o+"px"),l.css({height:o,width:o}),g.sparePieces===!0&&h.find("div."+w.sparePieces).css("paddingLeft",o+z+"px"),cb()},x.start=function(a){x.position("start",a)};var pb=function(){return"ontouchstart"in document.documentElement},qb=function(){return navigator&&navigator.userAgent&&-1!==navigator.userAgent.search(/MSIE/)},rb=function(a){a.preventDefault()},sb=function(a){if(g.draggable===!0){var b=$(this).attr("data-square");c(b)===!0&&B.hasOwnProperty(b)===!0&&mb(b,B[b],a.pageX,a.pageY)}},tb=function(a){if(g.draggable===!0){var b=$(this).attr("data-square");c(b)===!0&&B.hasOwnProperty(b)===!0&&(a=a.originalEvent,mb(b,B[b],a.changedTouches[0].pageX,a.changedTouches[0].pageY))}},ub=function(a){if(g.sparePieces===!0){var b=$(this).attr("data-piece");mb("spare",b,a.pageX,a.pageY)}},vb=function(a){if(g.sparePieces===!0){var b=$(this).attr("data-piece");a=a.originalEvent,mb("spare",b,a.changedTouches[0].pageX,a.changedTouches[0].pageY)}},wb=function(a){C===!0&&nb(a.pageX,a.pageY)},xb=function(a){C===!0&&(a.preventDefault(),nb(a.originalEvent.changedTouches[0].pageX,a.originalEvent.changedTouches[0].pageY))},yb=function(a){if(C===!0){var b=gb(a.pageX,a.pageY);ob(b)}},zb=function(a){if(C===!0){var b=gb(a.originalEvent.changedTouches[0].pageX,a.originalEvent.changedTouches[0].pageY);ob(b)}},Ab=function(){$("body").on("mousedown mousemove","img."+w.piece,rb),k.on("mousedown","div."+w.square,sb),h.on("mousedown","div."+w.sparePieces+" img."+w.piece,ub),qb()===!0?(document.ondragstart=function(){return!1},$("body").on("mousemove",wb),$("body").on("mouseup",yb)):($(window).on("mousemove",wb),$(window).on("mouseup",yb)),pb()===!0&&(k.on("touchstart","div."+w.square,tb),h.on("touchstart","div."+w.sparePieces+" img."+w.piece,vb),$(window).on("touchmove",xb),$(window).on("touchend",zb))},Bb=function(){h.html(P()),k=h.find("div."+w.board),g.sparePieces===!0&&(m=h.find("div."+w.sparePiecesTop),n=h.find("div."+w.sparePiecesBottom));var a=F();$("body").append(S("wP",!0,a)),l=$("#"+a),z=parseInt(k.css("borderLeftWidth"),10),x.resize()},Cb=function(){K()===!0&&M()===!0&&(O(),Bb(),Ab())};return Cb(),x},window.ChessBoard.fenToObj=i,window.ChessBoard.objToFen=j}(),_.mixin({pad:function(a,b){return this.map(this.range(a),function(){return b})}});var a={king:"k",queen:"q",rook:"r",knight:"n",bishop:"b",pawn:"p"},b={black:"b",white:"w"};!function(){"use strict";var c={};this.createPieceModel=c;var d=function(a,c,d){c=c||{};var e={};e.side=function(){return d.side},e.type=function(){return a},e.getMoves=function(a,b){d.tempBoard=b;var c=d.getMoves(a);return d.tempBoard=void 0,c},d.tempBoard=void 0,d.side=c.side,d.isOnBoard=function(a){return a.x>=0&&a.x<8&&a.y>=0&&a.y<8};var f=function(a){return d.isOnBoard(a)?d.tempBoard[a.y][a.x]:void 0},g=function(a){var b=f(a);return b&&b.side()};d.isOpponent=function(a){var c=g(a),d=e.side();return c===b.white&&d===b.black||c===b.black&&d===b.white},d.isAlly=function(a){return g(a)===e.side()};var h=function(a,b,c){for(var e=b(a),f=c(a),g=i(),h=i(),j=[];d.isOnBoard(e)&&!g(e);)j.push(e),e=b(e);for(;d.isOnBoard(f)&&!h(f);)j.push(f),f=c(f);return j},i=function(){var a=!1;return function(b){var c=!1;return a?c=!0:d.isAlly(b)?c=!0:d.isOpponent(b)&&(a=!0),c}};d.advance=function(a,b,c){return{x:c.x+a,y:c.y+b}};var j=function(a,b){return _.partial(d.advance,a,b)};return d.horizontal=function(a){return h(a,j(-1,0),j(1,0))},d.vertical=function(a){return h(a,j(0,1),j(0,-1))},d.rising=function(a){return h(a,j(1,-1),j(-1,1))},d.falling=function(a){return h(a,j(1,1),j(-1,-1))},e};c.king=function(b){b=b||{};var c={},e=d(a.king,b,c);return e.isMoved=!1,c.getMoves=function(a){return _.filter(_.map([[1,1],[1,0],[1,-1],[0,1],[0,-1],[-1,1],[-1,0],[-1,-1]],function(b){return c.advance(b[0],b[1],a)}),function(a){return c.isOnBoard(a)&&!c.isAlly(a)})},e},c.queen=function(b){b=b||{};var c={},e=d(a.queen,b,c);return c.getMoves=function(a){return _.union(c.horizontal(a),c.vertical(a),c.rising(a),c.falling(a))},e},c.rook=function(b){b=b||{};var c={},e=d(a.rook,b,c);return e.isMoved=!1,c.getMoves=function(a){return _.union(c.horizontal(a),c.vertical(a))},e},c.bishop=function(b){b=b||{};var c={},e=d(a.bishop,b,c);return c.getMoves=function(a){return _.union(c.rising(a),c.falling(a))},e},c.knight=function(b){b=b||{};var c={},e=d(a.knight,b,c);return c.getMoves=function(a){return _.filter(_.map([[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]],function(b){return c.advance(b[0],b[1],a)}),function(a){return c.isOnBoard(a)&&!c.isAlly(a)})},e},c.pawn=function(c){c=c||{};var e={},f=d(a.pawn,c,e),g=function(a){var c,d,g=[];return f.side()===b.black?(c=1,d=1):(c=-1,d=6),g.push({x:a.x,y:a.y+c}),a.y===d&&g.push({x:a.x,y:a.y+2*c}),_.filter(g,function(a){return e.isOnBoard(a)&&!e.isOpponent(a)&&!e.isAlly(a)})},h=function(a){var c=f.side()===b.black?1:-1;return _.filter([{x:a.x+1,y:a.y+c},{x:a.x-1,y:a.y+c}],e.isOpponent)};return e.getMoves=function(a){return _.union(g(a),h(a))},f.isEnPassant=!1,f}}.call(this),createBoardModel=function(c){"use strict";c=c||{};var d=jsMessage.mixinPubSub(),e=function(){var a=[],b=[];return{clear:function(){a=[],b=[]},push:function(b){a.push(b)},undo:function(){var c=a.pop();return c?(b.push(c),_.last(a)):void 0},redo:function(){var c=b.pop();return c?(a.push(c),_.last(a)):void 0}}}(),f=function(a){return _.map(a,function(a){return _.map(a,function(a){return a&&{side:a.side(),type:a.type()}})})},g=function(b){return _.map(b,function(b){return _.map(b,function(b){if(b){var c=_.invert(a)[b.type];return createPieceModel[c]({side:b.side})}return null})})},h=d.autoPublish("board",f),i=d.autoPublish("side"),j=!1,k=function(){var a=function(a){return _.map(["rook","knight","bishop","queen","king","bishop","knight","rook"],function(b){return createPieceModel[b]({side:a})})},c=function(){return _.pad(8,null)},d=function(a){return _.map(_.range(8),function(){return createPieceModel.pawn({side:a})})};return function(){return[a(b.black),d(b.black),c(),c(),c(),c(),d(b.white),a(b.white)]}}(),l=function(b){return _.map(b,function(b){return _.map(b,function(b){var c;return b?(c=_.invert(a)[b.type()],createPieceModel[c]({side:b.side()})):null})})},m=function(a,b){return b?b[a.y][a.x]:h()[a.y][a.x]},n=function(a,b,c){if(c)c[b.y][b.x]=a;else{var d=h();d[b.y][b.x]=a,h(d)}},o=function(b){w(b,function(b){b&&b.type()===a.pawn&&(b.isEnPassant=!1)})},p=function(b,c,d){var e=m(b,d);o(d||h()),e&&(e.type()===a.king||e.type()===a.rook?e.isMoved=!0:e.type()===a.pawn&&2===Math.abs(b.y-c.y)&&(e.isEnPassant=!0)),n(e,c,d),n(null,b,d)},q=function(a){var c=a||i();return c===b.black?b.white:b.black},r=function(){i(q()),e.push({board:f(h()),side:i()}),s()&&d.publish("winner",q())},s=function(){var a,b=!0;return x(h())?(w(h(),function(c,d){c&&c.side()===i()&&_.each(c.getMoves(d,h()),function(c){a=l(h()),p(d,c,a),x(a)||(b=!1)})}),b):!1},t=function(a){var b=m(a);return b&&b.side()===i()},u=function(a,b){return _.find(m(a).getMoves(a,h()),_.partial(_.isEqual,b))?!0:!1},v=function(b){var c={};return w(b,function(b,d){b&&b.type()===a.king&&(c[b.side()]=d)}),c},w=function(a,b){var c,d,e;for(d=0;d<a.length;d+=1)for(e=a[d],c=0;c<e.length;c+=1)b(m({x:c,y:d},a),{x:c,y:d})},x=function(a,b){var c=b||i(),d=v(a)[c],e=!1;return w(a,function(b,f){b&&b.side()===q(c)&&_.each(b.getMoves(f,a),function(a){_.isEqual(a,d)&&(e=!0)})}),e},y=function(a,b){return!(4!==a.x||0!==a.y&&7!==a.y||6!==b.x&&2!==b.x||a.y!==b.y)},z=function(a){return 6===a.x?{x:7,y:a.y}:{x:0,y:a.y}},A=function(a){return 6===a.x?{x:5,y:a.y}:{x:3,y:a.y}},B=function(b){var c=z(b),d=m(c);return d&&d.side()===i()&&d.type()===a.rook},C=function(a,b){var c=l(h());return p(a,b,c),p(z(b),A(b),c),x(c)},D=function(a,b){var c=l(h());return p(a,{x:2===b.x?a.x-1:a.x+1,y:b.y},c),x(c)},E=function(){var a=m(v(h())[i()]);return!a.isMoved},F=function(b){var c=m(z(b));return c&&c.type()===a.rook&&!c.isMoved},G=function(a,b){p(a,b),p(z(b),A(b))},H=function(a){return 6===a.x?null===m({x:5,y:a.y})&&null===m({x:6,y:a.y}):null===m({x:3,y:a.y})&&null===m({x:2,y:a.y})&&null===m({x:1,y:a.y})},I=function(a,b){var c=l(h());return p(a,b,c),x(c)},J=function(c,d){var e=m(c),f=m({x:d.x,y:c.y});return e&&e.type()===a.pawn&&1===Math.abs(c.x-d.x)&&1===Math.abs(c.y-d.y)&&null===m(d)&&f.type()===a.pawn&&f.side()===q()&&f.isEnPassant?i()===b.white?c.y-d.y>0:c.y-d.y<0:!1},K=function(c,d){var e=m(c);return e&&e.type()===a.pawn&&(e.side()===b.white&&0===d.y||e.side()===b.black&&7===d.y)&&u(c,d)};if(c.board&&c.side)h(c.board),i(c.side),e.push({board:f(c.board),side:c.side});else if(c.board||c.side)throw"must supply board and side or none at all";d.undo=function(){var a=e.undo();a&&(i(a.side),h(g(a.board)))},d.redo=function(){var a=e.redo();a&&(i(a.side),h(g(a.board)))},d.getGameState=function(){return{side:i(),board:f(h())}},d.loadGame=function(a,b){e.clear(),h(g(a)),i(b)},d.newGame=function(){e.clear(),h(k()),i(b.white),e.push({board:f(h()),side:i()}),d.publish("newGame",{})};var L=function(){var c,d=i()===b.black?7:0;return w(h(),function(b,e){e.y===d&&b&&b.type()===a.pawn&&b.side()===i()&&(c=e)}),c};return d.promotePawn=function(b){var c=L(),d=m(c),e=_.invert(a)[b];!d||d.type()!==a.pawn||0!==c.y&&7!==c.y||(n(createPieceModel[e]({side:i()}),c),r(),j=!1)},d.isOwnPiece=function(a){return t(a)},d.makeMove=function(a,b){var c;return t(a)&&!j?y(a,b)?B(b)&&E()&&F(b)&&H(b)&&!C(a,b)&&!D(a,b)?(G(a,b),r(),c=!0):c=!1:J(a,b)&&!I(a,b)?(n(null,{x:b.x,y:a.y}),p(a,b),r(),c=!0):K(a,b)&&!I(a,b)?(p(a,b),j=!0,c=!0,d.publish("pawnPromotion",i())):u(a,b)&&!I(a,b)?(p(a,b),r(),c=!0):c=!1:c=!1,c},d};var c=function(c){"use strict";c=c||{};var d="respond.php/",e=jsMessage.mixinPubSub(),f=c.model||createBoardModel(),g=c.view||new ChessBoard("board"),h=null,i={P:a.pawn,R:a.rook,N:a.knight,B:a.bishop,K:a.king,Q:a.queen},j={b:b.black,w:b.white},k=function(a){return _.invert(j)[a.side]+_.invert(i)[a.type]},l=function(a){return{x:a.charCodeAt(0)-97,y:8-Number(a.charAt(1))}},m=function(a){return String.fromCharCode(a.x+97)+String(8-a.y)},n=function(a){var b={};return _.each(a,function(a,c){return _.each(a,function(a,d){if(a){var e=m({x:d,y:c});b[e]=k(a)}})}),b};return e.bindSaveLoad=function(){$("#save-game").click(function(){e.saveGame()}),$("#load-game").click(function(){e.loadGame($("#game-load-id").val())})},e.bindNewGame=function(){$("#new-game").click(function(){f.newGame()})},e.saveGame=function(){var a=f.getGameState();console.log(a),$.ajax({type:"POST",url:d+"game",data:{board:JSON.stringify(a.board),side:a.side},beforeSend:function(){$("#save-game").button("loading")},error:function(){console.log(arguments)},success:function(a){$("#game-id").html(a)},complete:function(){$("#save-game").button("reset")},dataType:"json"})},e.loadGame=function(a){console.log("id:"+a),$.ajax({type:"GET",url:d+"game/"+a,beforeSend:function(){$("#load-game").button("loading")},error:function(){console.log(arguments)},success:function(a){f.loadGame(JSON.parse(a.board),a.side)},complete:function(){$("#load-game").button("reset")},dataType:"json"})},e.newGame=function(){},e.bindSquareClick=function(){$(".square-55d63").click(function(){$(".square-55d63").removeClass("selected"),e.clickSquare($(this).attr("data-square"))&&$(this).addClass("selected")})},e.bindPawnPromotionSelect=function(){$("#bQ").click(function(){$("#select-piece-black").modal("hide"),f.promotePawn(a.queen)}),$("#bN").click(function(){$("#select-piece-black").modal("hide"),f.promotePawn(a.knight)}),$("#wQ").click(function(){$("#select-piece-white").modal("hide"),f.promotePawn(a.queen)}),$("#wN").click(function(){$("#select-piece-white").modal("hide"),f.promotePawn(a.knight)})},e.bindUndoRedo=function(){$("#undo").click(_.bind(e.undo,e)),$("#redo").click(_.bind(e.redo,e))},e.undo=function(){console.log("undo"),f.undo()},e.redo=function(){console.log("redo"),f.redo()},e.boardUpdate=function(a){g.position(n(a))},e.declareWinner=function(a){var c=a===b.black?"Black":"White";$("#display-winner .modal-title").html(c+" Wins!"),$("#display-winner").modal("show")},e.promotePawn=function(a){var c=a===b.black?"black":"white";$("#select-piece-"+c).modal()},e.sideUpdate=function(a){var c=200;$("#status-indicator").html(a===b.white?"White's move.":"Black's move."),$("#is-change-orientation").is(":checked")&&setTimeout(function(){$("#board img").fadeOut(c),setTimeout(function(){g.orientation(a===b.white?"white":"black");var d=$("#board img");d.hide(),d.fadeIn(c),e.bindSquareClick()},c)},c)},e.clickSquare=function(a){var b=l(a);return h?f.isOwnPiece(b)?h=b:(f.makeMove(h,b),h=null):f.isOwnPiece(b)&&(h=b),h?!0:!1},e};window.createChess=function(a){"use strict";a=a||{};var b=new ChessBoard("board",{showNotation:!1,pieceTheme:a.pieceTheme||void 0}),d=createBoardModel(),e=c({model:d,view:b});d.subscribe("board",_.bind(e.boardUpdate,e)),d.newGame(),d.subscribe("side",_.bind(e.sideUpdate,e)),d.subscribe("pawnPromotion",_.bind(e.promotePawn,e)),d.subscribe("winner",_.bind(e.declareWinner,e));var f=function(){var a=$("#board"),c=$("#controls"),d=$("#chess-container").width(),e=$("#chess-container").height();a.width(_.min([d,e])-2),b.resize(),d>e?(c.width(d-e-0),c.addClass("horizontal-controls")):(c.width(d-2),c.removeClass("horizontal-controls"))};f(),$(window).resize(function(){f(),b.resize(arguments),e.bindSquareClick()}),e.bindSquareClick(),e.bindPawnPromotionSelect(),e.bindUndoRedo(),e.bindSaveLoad(),e.bindNewGame()}}();